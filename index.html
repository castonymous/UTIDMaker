<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>ID Card UT â€“ Liquid Glass + CSV Mass Export</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  body{
    margin:20px;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    display:flex; gap:24px;
    background:#e5e7eb;
  }

  .panel{
    width:360px; background:white; padding:16px;
    border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,0.1);
  }
  label{display:block;font-size:13px;margin-top:10px}
  input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
  button{
    margin-top:14px;padding:10px 16px;border:0;border-radius:10px;
    background:#0A84FF;color:white;font-size:14px;cursor:pointer;
  }

  .preview-wrap{background:white; padding:10px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1)}
  .rotate{transform:rotate(90deg); transform-origin:center}

  /* ID card */
  .id-card{
    width:56mm;
    height:88mm;
    background:rgba(255,255,255,0.25);
    backdrop-filter:blur(16px);
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.6);
    padding:10mm; box-sizing:border-box;
    position:relative;
    overflow:hidden;
  }

  .logo{position:absolute; left:10mm; top:10mm; width:14mm;}
  .title{position:absolute; left:26mm; top:11mm; font-weight:600; font-size:12pt}
  .photo{position:absolute; right:10mm; top:20mm; width:24mm; height:32mm; border-radius:8px; overflow:hidden}
  .photo img{width:100%;height:100%;object-fit:cover}

  .qrbox{position:absolute; left:10mm; top:28mm; width:24mm; height:24mm}
  .info{position:absolute; left:38mm; top:28mm; font-size:9pt}
  .field{margin-bottom:4px}
  .label{font-size:7pt;color:#777}
  .value{font-weight:600}
</style>
</head>
<body>

<div class="panel">

  <h3>Input Data</h3>

  <label>NIM</label><input id="nim" value="056130911">

  <label>Nama</label><input id="nama" value="CASTO">

  <label>Jurusan</label><input id="jurusan" value="252 / SISTEM INFORMASI S1">

  <label>Tanggal Lahir</label><input id="dob" value="25/01/2000">

  <label>UPBJJ</label><input id="upbjj" value="41 / PURWOKERTO">

  <label>MRI</label><input id="mri" value="20182">

  <label>Berlaku</label><input id="berlaku" value="24-06-2025">

  <label>Link untuk QR</label><input id="qrlink" value="https://example.com/profile/056130911">

  <label>Pas Foto</label>
  <input id="foto" type="file" accept="image/*">

  <button id="update">Update Preview</button>
  <button id="download">Download PNG Portrait</button>

  <hr style="margin:20px 0">

  <h3>Mass Import CSV</h3>
  <input id="csv" type="file" accept=".csv">

  <button id="gen-bulk">Generate Massal (ZIP)</button>
</div>

<div class="preview-wrap">
  <div class="rotate">
    <div id="card" class="id-card">
      <img class="logo" src="https://upload.wikimedia.org/wikipedia/commons/5/5f/Universitas_Terbuka_%28UT%29_logo.svg">

      <div class="title">KARTU MAHASISWA</div>

      <div class="photo"><img id="imgFoto"></div>
      <div class="qrbox" id="qr"></div>

      <div class="info">
        <div class="field"><div class="label">NIM</div><div class="value" id="v-nim"></div></div>
        <div class="field"><div class="label">Nama</div><div class="value" id="v-nama"></div></div>
        <div class="field"><div class="label">Jurusan</div><div class="value" id="v-jurusan"></div></div>
        <div class="field"><div class="label">Tanggal Lahir</div><div class="value" id="v-dob"></div></div>
        <div class="field"><div class="label">UPBJJ</div><div class="value" id="v-upbjj"></div></div>
        <div class="field"><div class="label">MRI</div><div class="value" id="v-mri"></div></div>
        <div class="field"><div class="label">Berlaku</div><div class="value" id="v-berlaku"></div></div>
      </div>
    </div>
  </div>
</div>

<script>

function updateCard(data={}){

  const get = id => data[id] ?? document.getElementById(id).value;

  document.getElementById("v-nim").textContent = get("nim");
  document.getElementById("v-nama").textContent = get("nama");
  document.getElementById("v-jurusan").textContent = get("jurusan");
  document.getElementById("v-dob").textContent = get("dob");
  document.getElementById("v-upbjj").textContent = get("upbjj");
  document.getElementById("v-mri").textContent = get("mri");
  document.getElementById("v-berlaku").textContent = get("berlaku");

  // QR
  document.getElementById("qr").innerHTML = "";
  new QRCode(document.getElementById("qr"), {
    text: get("qrlink"),
    width: 160,
    height: 160
  });

  // FOTO
  if(data.fotoBase64){
    document.getElementById("imgFoto").src = data.fotoBase64;
  }
}

document.getElementById("foto").addEventListener("change", e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev => document.getElementById("imgFoto").src = ev.target.result;
  r.readAsDataURL(f);
});

document.getElementById("update").onclick = ()=>updateCard();

updateCard();


// EXPORT PORTRAIT PNG
document.getElementById("download").onclick = async ()=>{

  const card = document.getElementById("card");

  const dpi = 300;
  const pxW = Math.round(56 * dpi / 25.4);
  const pxH = Math.round(88 * dpi / 25.4);

  const rect = card.getBoundingClientRect();
  const scale = pxH / rect.height;

  const canvas = await html2canvas(card, {
    scale:scale, backgroundColor:null
  });

  const final = document.createElement("canvas");
  final.width = pxW;
  final.height = pxH;
  final.getContext("2d").drawImage(canvas, 0, 0, pxW, pxH);

  const a=document.createElement("a");
  a.href=final.toDataURL("image/png");
  a.download="idcard.png";
  a.click();
};


// MASS GENERATION
document.getElementById("gen-bulk").onclick = async ()=>{
  const file = document.getElementById("csv").files[0];
  if(!file){ alert("Upload CSV dulu bro!"); return; }

  const text = await file.text();
  const rows = text.split("\n").map(r=>r.split(",").map(s=>s.trim()));

  const headers = rows.shift();
  const zip = new JSZip();

  for(const row of rows){
    if(row.length < 8) continue;

    const obj = {};
    headers.forEach((h,i)=>obj[h]=row[i]);

    // Foto optional
    let fotoB64 = null;
    if(obj.foto){
      // diasumsikan foto adalah URL
      const img = await fetch(obj.foto).then(r=>r.blob());
      fotoB64 = await new Promise(res=>{
        const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(img);
      });
    }

    updateCard({
      ...obj,
      fotoBase64: fotoB64
    });

    const card = document.getElementById("card");

    const dpi = 300;
    const pxW = Math.round(56 * dpi / 25.4);
    const pxH = Math.round(88 * dpi / 25.4);
    const s = pxH / card.getBoundingClientRect().height;

    const canvas = await html2canvas(card,{scale:s,backgroundColor:null});

    const final = document.createElement("canvas");
    final.width=pxW; final.height=pxH;
    final.getContext("2d").drawImage(canvas,0,0,pxW,pxH);

    const b64 = final.toDataURL("image/png").split(",")[1];

    zip.file(`${obj.nim}.png`, b64, {base64:true});
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="idcard_massal.zip";
  a.click();
};

</script>
</body>
</html>
